from openai import OpenAI
from concurrent.futures import ThreadPoolExecutor, as_completed
import json

# vLLM server endpoint
client = OpenAI(
    base_url="http://0.0.0.0:8002/v1",
    api_key="not-needed"
)

MODEL_ID = "deepseek"


# ---------------- Helper: one chat call ----------------
def generate_chat(query: str, trace: str, temperature=0.2):

    payload = {
        "model": MODEL_ID,
        "messages": [
            {
                "role": "user",
                "content": f"{query} and {trace}"
            }
        ],
        "temperature": temperature,
        "top_p": 0.95,
        "seed": 42,
        "max_tokens": 256
    }

    try:
        response = client.chat.completions.create(**payload)
        return response.choices[0].message["content"]
    except Exception as e:
        return f"ERROR: {str(e)}"


# ---------------- Process Dataset ----------------
def process_dataset(dataset: dict, max_concurrency: int = 43):
    all_results = {}

    for list_id, json_list in dataset.items():
        print(f"\n========= Processing List {list_id} =========")

        list_results = []

        # Prepare concurrent tasks for all items in this list
        with ThreadPoolExecutor(max_workers=max_concurrency) as executor:

            futures = {}
            for item in json_list:
                q = item["query"]
                tr = item["trace"]
                futures[executor.submit(generate_chat, q, tr)] = (q, tr)

            for future in as_completed(futures):
                query, trace = futures[future]

                try:
                    answer = future.result()
                except Exception as e:
                    answer = f"ERROR: {str(e)}"

                list_results.append({
                    "query": query,
                    "trace": trace,
                    "response": answer
                })

        all_results[list_id] = list_results

    return all_results


# ---------------- Example use ----------------
if __name__ == "__main__":
    dataset = {
        1: [
            {"query": "Solve 1+1", "trace": "simple addition"},
            {"query": "Multiply 5Ã—9", "trace": "basic multiplication"},
        ]
    }

    results = process_dataset(dataset)
    json.dump(results, open("outputs.json", "w"), indent=2)

    print("DONE. Saved to outputs.json")
